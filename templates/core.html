<!DOCTYPE html>
<html>
<head>
    <title>Car Path</title>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/@googlemaps/extended-component-library/0.6.11/index.min.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <link rel="stylesheet" href="static/styles/core.css"/>
</head>
<body>
    <gmpx-api-loader key="AIzaSyAZMTnhsyiK_U2mMPxHww9w2dXQU_gvcQU" solution-channel="GMP_GE_mapsandplacesautocomplete_v2">
    </gmpx-api-loader>
    
    <gmp-map center="40.749933,-73.98633" zoom="13" map-id="DEMO_MAP_ID">
        <div slot="control-block-start-inline-start" class="place-picker-container">
            <gmpx-place-picker placeholder="Enter an address"></gmpx-place-picker>
        </div>
    </gmp-map>

    <script>
        let map;
        let markers = {}; // Store car markers
        let paths = {}; // Store polylines for each car
        let lastCarId = null; // Track the last focused car for zoom adjustments

        async function init() {
            console.log("ðŸš€ Initializing Google Map...");

            await customElements.whenDefined("gmp-map");
            map = document.querySelector("gmp-map");

            map.innerMap.setOptions({
                mapTypeControl: false
            });

            console.log("âœ… Map initialized successfully.");

            // Connect to WebSocket server (Optimized for fast reconnects)
            const socket = io.connect(window.location.origin, {
                transports: ['websocket'],  // ðŸš€ Force WebSocket (no polling delays)
                reconnectionAttempts: 5,    // Retry 5 times if disconnected
                reconnectionDelay: 500,     // Short delay for faster reconnects
                timeout: 2000               // Reduce timeout for quicker fallback
            });

            console.log("ðŸ”Œ Connecting to WebSocket server...");

            socket.on("connect", () => {
                console.log("âœ… WebSocket connected!");
            });

            socket.on("car_location_updated", (carData) => {
                console.log("ðŸ“¡ Received car location update:", carData);
                updateCarLocation(carData);
            });

            socket.on("disconnect", () => {
                console.log("âŒ WebSocket disconnected!");
            });
        }

        // Update car position and draw path
        function updateCarLocation(carData) {
            const { carId, latitude, longitude } = carData;
            console.log(`ðŸš— Updating position for ${carId} â†’ (${latitude}, ${longitude})`);

            const position = new google.maps.LatLng(latitude, longitude);

            if (!markers[carId]) {
                console.log(`ðŸ†• Creating new marker for ${carId}`);

                // Create a new marker for the car
                markers[carId] = new google.maps.Marker({
                    position: position,
                    map: map.innerMap,
                    title: `Car ${carId}`,
                    icon: {
                        url: "https://maps.google.com/mapfiles/kml/shapes/cabs.png", // Car icon
                        scaledSize: new google.maps.Size(40, 40),
                    },
                });

                // Create a polyline for the car's path
                paths[carId] = new google.maps.Polyline({
                    path: [position],
                    geodesic: true,
                    strokeColor: getRandomColor(),
                    strokeOpacity: 1.0,
                    strokeWeight: 3,
                    map: map.innerMap,
                });

                console.log(`âœ… Marker and path created for ${carId}`);
            } else {
                console.log(`âœï¸ Updating marker position for ${carId}`);

                // Move the marker to the new position
                markers[carId].setPosition(position);

                // Update the polyline path
                const path = paths[carId].getPath();
                path.push(position);

                console.log(`ðŸ“ˆ Path updated for ${carId}`);
            }

            // Smooth camera movement to focus on car
            animateCameraToPosition(position, carId);
        }

        // Smooth camera animation to new position
        function animateCameraToPosition(position, carId) {
            if (lastCarId !== carId) {
                // If a new car is updated, zoom in smoothly
                map.innerMap.setZoom(15);
                lastCarId = carId;
            }

            map.innerMap.panTo(position); // Smooth camera movement
            console.log(`ðŸ”„ Camera panned to ${carId}'s new location`);
        }

        // Generate a random color for different cars
        function getRandomColor() {
            const color = `#${Math.floor(Math.random() * 16777215).toString(16)}`;
            console.log(`ðŸŽ¨ Generated random color: ${color}`);
            return color;
        }

        document.addEventListener("DOMContentLoaded", () => {
            console.log("ðŸ“œ Document loaded, initializing map...");
            init();
        });
    </script>
</body>
</html>
